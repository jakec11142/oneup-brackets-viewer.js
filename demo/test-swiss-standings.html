<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Swiss Test with Realistic Standings</title>
  <link rel="stylesheet" href="../dist/brackets-viewer.min.css" />
  <script src="../dist/brackets-viewer.min.js"></script>
  <style>
    body { margin:0; padding:20px; background:#f5f5f5; font-family:sans-serif; }
    h1 { font-size:20px; margin-bottom:10px; color:#1e293b; }
    .subtitle { font-size:14px; color:#64748b; margin-bottom:20px; }
    #viewer-root { background:#fff; border-radius:8px; padding:20px; box-shadow:0 6px 24px rgba(15,23,42,.1); }
    #status { background:#fff; padding:15px; border-radius:4px; margin-bottom:20px; }
    .log-item { padding:5px 0; font-size:13px; font-family:monospace; }
    .log-success { color:#10b981; }
    .log-error { color:#ef4444; }
    .log-info { color:#3b82f6; }
  </style>
</head>
<body>
  <h1>Swiss with Realistic Standings (UUID-style IDs)</h1>
  <div class="subtitle">
    This test uses UUID-style match IDs but with REALISTIC standings data.<br>
    Teams have different win-loss records, so matches should distribute across multiple panels.
  </div>
  <div id="status">
    <div class="log-item log-info">‚è≥ Loading Swiss data with realistic standings...</div>
  </div>
  <section id="viewer-root" class="brackets-viewer"></section>

  <script type="module">
    const statusDiv = document.querySelector('#status');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log-item log-${type}`;
      div.textContent = message;
      statusDiv.appendChild(div);
      console.log(message);
    }

    async function testSwissStandings() {
      try {
        log('‚è≥ Fetching Swiss data...');
        const response = await fetch('swissData.json');
        const structure = await response.json();
        log('‚úì Swiss data loaded', 'success');

        log('‚è≥ Converting to viewer data (WITH standings)...');
        const viewerData = window.bracketsViewerDTO.convertStageStructureToViewerData(structure, structure, {
          stageName: 'Swiss Standings Test',
        });
        log(`‚úì Converted: ${viewerData.matches.length} matches, ${viewerData.participants.length} participants`, 'success');

        // Check Swiss metadata
        const withMeta = viewerData.matches.filter(m => m.swissWins !== undefined && m.swissLosses !== undefined);
        log(`üìä Matches with Swiss metadata: ${withMeta.length} / ${viewerData.matches.length}`, withMeta.length > 0 ? 'success' : 'error');

        if (withMeta.length > 0) {
          const buckets = new Map();
          withMeta.forEach(m => {
            const key = `${m.swissWins}-${m.swissLosses}`;
            buckets.set(key, (buckets.get(key) || 0) + 1);
          });
          log('üéØ Distribution by record:', 'info');
          Array.from(buckets.entries()).sort().forEach(([record, count]) => {
            log(`   ${record}: ${count} matches`, 'info');
          });
        }

        log('‚è≥ Rendering bracket...');
        await window.bracketsViewer.render(viewerData, {
          selector: '#viewer-root',
          clear: true,
          showRoundHeaders: false,
        });
        log('‚úì Rendering complete', 'success');

        const panels = document.querySelectorAll('.swiss-panel');
        log(`‚úì Found ${panels.length} Swiss panels on page`, panels.length > 1 ? 'success' : 'error');

        if (panels.length > 0) {
          panels.forEach((panel, idx) => {
            const header = panel.querySelector('.swiss-panel-header');
            const record = header ? header.querySelector('.record')?.textContent : 'N/A';
            const matches = panel.querySelectorAll('.match');
            log(`  Panel ${idx + 1}: Record="${record}", Matches=${matches.length}`, 'info');
          });
        }

      } catch (error) {
        log(`‚úó Error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    window.addEventListener('load', testSwissStandings);
  </script>
</body>
</html>
