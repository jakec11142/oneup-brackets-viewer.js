<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Swiss Panel Test</title>
  <link rel="stylesheet" href="../dist/brackets-viewer.min.css" />
  <script src="../dist/brackets-viewer.min.js"></script>
  <style>
    body { margin:0; padding:20px; background:#f5f5f5; font-family:sans-serif; transition: background 0.3s; }
    body.dark { background:#1a1a1a; color:#f5f5f5; }
    h1 { font-size:18px; margin-bottom:20px; }
    #viewer-root { background:#fff; border-radius:8px; padding:20px; box-shadow:0 6px 24px rgba(15,23,42,.1); }
    body.dark #viewer-root { background:#1e1e1e; box-shadow:0 6px 24px rgba(0,0,0,.3); }
    #status { background:#fff; padding:15px; border-radius:4px; margin-bottom:20px; }
    body.dark #status { background:#2a2a2a; }
    .log-item { padding:5px 0; font-size:13px; font-family:monospace; }
    .log-success { color:#10b981; }
    .log-error { color:#ef4444; }
    .log-info { color:#3b82f6; }

    /* Theme toggle */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #374151;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      z-index: 1000;
    }
    .theme-toggle:hover { background: #4b5563; }
    body.dark .theme-toggle { background: #f5f5f5; color: #1a1a1a; }
    body.dark .theme-toggle:hover { background: #e5e5e5; }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
  <h1>Swiss Panel Rendering Test</h1>
  <div id="status">
    <div class="log-item log-info">‚è≥ Loading Swiss data...</div>
  </div>
  <section id="viewer-root" class="brackets-viewer"></section>

  <script type="module">
    const statusDiv = document.querySelector('#status');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log-item log-${type}`;
      div.textContent = message;
      statusDiv.appendChild(div);
      console.log(message);
    }

    async function testSwissRendering() {
      try {
        log('‚è≥ Fetching Swiss data...');
        const response = await fetch('swissData.json');
        const structure = await response.json();
        log('‚úì Swiss data loaded', 'success');

        log('‚è≥ Converting to viewer data...');
        // Pass both structure and standings (they're in the same data object)
        const viewerData = window.bracketsViewerDTO.convertStageStructureToViewerData(structure, structure, {
          stageName: 'Swiss Test',
        });
        log(`‚úì Converted: ${viewerData.matches.length} matches, ${viewerData.participants.length} participants`, 'success');

        log('‚è≥ Rendering bracket...');
        await window.bracketsViewer.render(viewerData, {
          selector: '#viewer-root',
          clear: true,
          showRoundHeaders: false,
        });
        log('‚úì Rendering complete', 'success');

        // Check for Swiss panels
        const panels = document.querySelectorAll('.swiss-panel');
        log(`‚úì Found ${panels.length} Swiss panels`, panels.length > 0 ? 'success' : 'error');

        if (panels.length > 0) {
          panels.forEach((panel, idx) => {
            const header = panel.querySelector('.swiss-panel-header');
            const body = panel.querySelector('.swiss-panel-body');
            const matches = body ? body.querySelectorAll('.match') : [];
            const record = header ? header.querySelector('.record')?.textContent : 'N/A';
            const date = header ? header.querySelector('.date')?.textContent : 'none';
            const bestOf = header ? header.querySelector('.bo-label')?.textContent : 'none';

            log(`  Panel ${idx + 1}: Record="${record}", Date="${date}", BestOf="${bestOf}", Matches=${matches.length}`, 'info');
          });
        }

        // Check for connectors (should be NONE)
        const connectors = document.querySelectorAll('.bracket-connectors line, .bracket-connectors path');
        if (connectors.length === 0) {
          log('‚úì No SVG connectors found (correct for Swiss panels)', 'success');
        } else {
          log(`‚ö† Found ${connectors.length} SVG connectors (should be 0)`, 'error');
        }

      } catch (error) {
        log(`‚úó Error: ${error.message}`, 'error');
        console.error(error);
      }
    }

    // Run test after page loads
    window.addEventListener('load', testSwissRendering);

    // Theme toggle
    window.toggleTheme = function() {
      const body = document.body;
      const viewer = document.querySelector('#viewer-root');
      const btn = document.querySelector('.theme-toggle');
      const isDark = body.classList.toggle('dark');

      // Toggle the built-in bracket theme
      viewer.classList.toggle('bv-theme-dark', isDark);

      btn.textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
    };
  </script>
</body>
</html>
